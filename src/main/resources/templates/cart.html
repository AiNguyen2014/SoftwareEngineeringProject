<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Giỏ hàng | WEBSHOE</title>

    <th:block th:replace="~{fragments :: head_header}"></th:block>
    <link rel="stylesheet" th:href="@{/css/cart.css}">
</head>

<body>

<div th:replace="~{fragments :: header}"></div>

<main class="cart-page">
    <!-- ================== NAVBAR (dùng CSS của bạn, KHÔNG Bootstrap) ================== -->
<header>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-links">
                <a class="nav-link" th:href="@{/}">Home</a> 
                <a class="nav-link active" th:href="@{/cart}">Cart</a>
            </div>
        </div>
    </nav>
</header>

    <!-- SUCCESS MESSAGE -->
    <div class="alert alert-success"
         th:if="${successMessage}"
         th:text="${successMessage}">
    </div>

    <!-- ERROR MESSAGE -->
    <div class="alert alert-danger"
     th:if="${errorMessage}"
     th:text="${errorMessage}">
    </div>

    <!-- ================== CART EMPTY ================== -->
    <section th:if="${cartItems == null || #lists.isEmpty(cartItems)}">
        <div class="cart-empty">
            <i class="fas fa-shopping-cart cart-empty-icon"></i>
            <h3>Giỏ hàng của bạn đang trống</h3>
            <p>Hãy khám phá và thêm sản phẩm vào giỏ nhé!</p>
            <a th:href="@{/}" class="btn-cart-primary">Khám phá sản phẩm</a>
        </div>
    </section>

    <!-- ================== CART HAS ITEMS ================== -->
    <section th:if="${cartItems != null && !#lists.isEmpty(cartItems)}">


            <div class="cart-card">

                <div class="cart-card-header">
                    <span></span>
                    <span>Sản phẩm</span>
                    <span>Đơn giá</span>
                    <span>Số lượng</span>
                    <span>Thành tiền</span>
                    <span></span>
                </div>

                <div class="cart-items">

                    <div class="cart-item-row" th:each="item : ${cartItems}">

                        <!-- CHECKBOX -->
                        <input type="checkbox"
                            class="cart-item-checkbox"
                            name="selectedCartItemIds"
                            th:value="${item.cartItemId}"
                            checked>

                        <!-- PRODUCT -->
                        <div class="cart-item-product">
                            <div class="cart-item-img">
                                <a th:href="@{/shoes/{id}(id=${item.shoeId})}">
                                    <img th:src="${item.imageUrl}"
                                         th:alt="${item.shoeName}">
                                </a>
                            </div>

                            <div class="cart-item-info">
                                <a class="cart-item-name"
                                   th:href="@{/shoes/{id}(id=${item.shoeId})}"
                                   th:text="${item.shoeName}">
                                </a>

                                <div class="cart-item-meta">
                                    <span th:text="${item.brand}"></span>
                                    <span class="dot">•</span>
                                    <span>Màu:
                                        <strong th:text="${item.color}"></strong>
                                    </span>
                                    <span class="dot">•</span>
                                    <span>Size:
                                        <strong th:text="${item.size}"></strong>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- UNIT PRICE -->
                        <div class="cart-item-price">
                            <span th:text="${#numbers.formatDecimal(item.unitPrice, 0, 'POINT', 0, 'COMMA')} + '₫'">
                            </span>
                        </div>

                        <!-- QUANTITY -->
                        <div class="cart-item-qty">
                            <form th:action="@{/cart/update}" method="post" class="qty-form">
                                <input type="hidden" name="cartItemId"
                                       th:value="${item.cartItemId}">

                                <button type="submit"
                                        name="action"
                                        value="decrease"
                                        class="qty-btn-cart btn-decrease"></button>
                                       
                                        -
                                </button>


                                <input type="text" class="qty-input-cart"
                                       th:value="${item.quantity}" readonly>

                                <button type="submit" name="action" value="increase"
                                        class="qty-btn-cart">+</button>
                            </form>
                        </div>

                        <!-- TOTAL -->
                        <div class="cart-item-total">
                            <span th:text="${#numbers.formatDecimal(item.subtotal, 0, 'POINT', 0, 'COMMA')} + '₫'">
                            </span>
                        </div>

                    </div>
                </div>
            </div>

            <!-- ================== SUMMARY ================== -->
            <div class="cart-summary-card">
                <h3>Tóm tắt đơn hàng</h3>

                <div class="summary-row">
                    <span>Tạm tính</span>
                    <span id="summary-subtotal" th:text="${#numbers.formatDecimal(cartSubtotal, 0, 'POINT', 0, 'COMMA')} + '₫'"></span>
                </div>

                <div class="summary-row">
                    <span>Phí vận chuyển</span>
                    <span id="summary-shipping" th:text="${#numbers.formatDecimal(cartShipping, 0, 'POINT', 0, 'COMMA')} + '₫'"></span>
                </div>

                <div class="summary-divider"></div>

                <div class="summary-row total">
                    <span>Tổng cộng</span>
                    <span id="summary-total" th:text="${#numbers.formatDecimal(cartTotal, 0, 'POINT', 0, 'COMMA')} + '₫'"></span>
                </div>

                <!-- CHECKOUT FORM -->
                <form id="checkout-form" th:action="@{/order/checkout}" method="get">
                    <input type="hidden" name="type" value="CART">
                    <input type="hidden" name="cartItemIds" id="selected-cart-item-ids" value="">
                    <button type="submit" class="btn-cart-primary w-100" id="checkout-btn">
                        <i class="fas fa-shopping-bag"></i> Đặt hàng
                    </button>
                </form>

                <!-- CONTINUE SHOPPING -->
                <a th:href="@{/}" class="btn-cart-secondary w-100">
                    <i class="fas fa-arrow-left"></i> Tiếp tục mua sắm
                </a>
            </div>
    </section>

</main>

<script>
    /* ================= CONFIRM DELETE WHEN qty = 1 ================= */
    document.querySelectorAll(".qty-form").forEach(form => {
    form.addEventListener("submit", function (e) {

        const submitBtn = e.submitter; // nút đã bấm
        if (!submitBtn || !submitBtn.classList.contains("btn-decrease")) {
            return; // không phải nút "-"
        }

        const qtyInput = form.querySelector(".qty-input-cart");
        const qty = parseInt(qtyInput.value);

        // CHỈ hỏi khi qty = 1
        if (qty === 1) {
            const ok = confirm("Sản phẩm sẽ bị xóa khỏi giỏ hàng. Bạn có chắc không?");
            if (!ok) {
                e.preventDefault(); 
            }
        }
    });
});
document.addEventListener("DOMContentLoaded", function () {

    /* ================= SUMMARY ================= */
    const SHIPPING_FEE = 30000;

    function formatCurrency(value) {
        return Math.round(value)
            .toString()
            .replace(/\B(?=(\d{3})+(?!\d))/g, ".") + "₫";
    }

    function updateSummary() {
        let subtotal = 0;
        let selectedCount = 0;

        document.querySelectorAll(".cart-item-checkbox").forEach(cb => {
            if (cb.checked) {
                const row = cb.closest(".cart-item-row");
                const totalText = row.querySelector(".cart-item-total span").textContent;
                subtotal += parseFloat(totalText.replace(/[₫.]/g, ""));
                selectedCount++;
            }
        });

        const shipping = selectedCount > 0 ? SHIPPING_FEE : 0;

        document.getElementById("summary-subtotal").textContent = formatCurrency(subtotal);
        document.getElementById("summary-shipping").textContent = formatCurrency(shipping);
        document.getElementById("summary-total").textContent = formatCurrency(subtotal + shipping);
    }

    document.querySelectorAll(".cart-item-checkbox")
        .forEach(cb => cb.addEventListener("change", updateSummary));

    document.getElementById("checkout-form").addEventListener("submit", function (e) {
        const checkedBoxes = document.querySelectorAll(".cart-item-checkbox:checked");
        
        if (checkedBoxes.length === 0) {
            e.preventDefault();
            alert("Vui lòng chọn ít nhất một sản phẩm để đặt hàng!");
            return;
        }
        
        // Lấy danh sách cartItemIds từ các checkbox đã chọn
        const selectedIds = Array.from(checkedBoxes)
            .map(cb => cb.value)
            .join(",");
        
        // Điền vào hidden input
        document.getElementById("selected-cart-item-ids").value = selectedIds;
        
        console.log("Selected cart item IDs:", selectedIds);
    });

    updateSummary();
});
</script>



</body>
</html>