@startuml ViewShoeDetail_Collaboration
!theme plain

title View Shoe Detail

actor "Registered Customer\nUnregistered Customer" as user
rectangle ":ShoesListUI" as listUI
rectangle ":ShoesDetailUI" as detailUI
rectangle ":ShoesController" as controller
rectangle ":ShoesService" as service
rectangle ":ShoesRepository" as repo
database "Database" as db

user -right-> listUI: 1: Chon san pham(id)

listUI -right-> controller: 1.1: GET /product/id

controller -down-> service: 1.1.1: getShoesDetail(id)

service -down-> repo: 1.1.1.1: findByIdWithImages(id)

repo -down-> db: SELECT s FROM Shoes s\nLEFT JOIN FETCH s.category\nLEFT JOIN FETCH s.images\nWHERE s.shoeId = id

db -up-> repo: Optional<Shoes>

repo -up-> service: Shoes with images

service -down-> repo: 1.1.1.2: findByIdWithVariants(id)

repo -down-> db: SELECT s FROM Shoes s\nLEFT JOIN FETCH s.variants\nWHERE s.shoeId = id

db -up-> repo: Optional<Shoes>

repo -up-> service: Shoes with variants

service -right-> service: 1.1.1.3: convertToDetailDto(shoes)

service -down-> repo: 1.1.1.4: findRelatedProducts(categoryId)

repo -down-> db: SELECT DISTINCT s FROM Shoes s\nLEFT JOIN FETCH s.images\nWHERE s.category.categoryId = catId\nAND s.shoeId != excludeId\nLIMIT 5

db -up-> repo: List<Shoes>

repo -up-> service: Related products list

service -up-> controller: 1.1.2: ShoesDetailDto

controller -down-> detailUI: 1.2: renderDetail(model)

detailUI -up-> user: Hien thi trang chi tiet

@enduml
