@startuml ViewShoeDetail_Sequence
!theme plain

title View Shoe Detail

actor "Registered Customer\nUnregistered Customer" as user
participant "ShoeDetailUI" as ui
participant "ShoesController" as controller
participant "ShoesService" as service
participant "ShoesRepository" as repo
database "Database" as db

== View Product Detail ==

user -> ui: Nhấn chọn sản phẩm
activate ui

ui -> controller: productDetail(shoeId)
activate controller

controller -> service: getShoesDetail(shoeId)
activate service

service -> repo: findByIdWithImages(shoeId)
activate repo
repo -> db: SELECT ... JOIN FETCH shoe_images, category
db --> repo: Optional<Shoes>
deactivate repo

alt Shoe not found
    service --> controller: throw NotFoundException
    controller --> ui: Redirect to Error Page
    ui --> user: Render Error Page (404)
else Shoe found
    service -> repo: findByIdWithVariants(shoeId)
    activate repo
    repo -> db: SELECT ... WHERE categoryId = ...
    db --> repo: Shoes (with Variants)
    deactivate repo
    
    loop For each Variant
        service -> service: convertToDetailDto(shoes)
    end
    
    service -> repo: findRelatedProducts(categoryId)
    activate repo
    repo -> db: SELECT ... WHERE categoryId = ...
    db --> repo: List<Shoes>
    deactivate repo
    
    service --> controller: ShoesDetailDto
    deactivate service
    
    controller -> ui: model.addAttribute("product", dto)
    ui --> user: Render trang chi tiết
    deactivate controller
    
    opt Customer nhấn chọn Size/Color
        user -> ui: Nhấn chọn Size/Màu
        ui -> ui: Update UI (Highlight selection)
    end
    
    opt Customer nhấn Thêm vào giỏ
        ref over user, db: Manage Cart
    end
end

deactivate ui

@enduml
